<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>webglpp</title>

  <!-- latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">

  <!-- jQuery library -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

  <!-- latest compiled JavaScript -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

  <!-- load MathJax for typesetting equations in LaTeX -->
  <script>
  MathJax = {
    tex: {inlineMath: [['$', '$'], ['\\(', '\\)']]}
  };
  </script>
  <script id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

  <!-- load gl-matrix: all functions and modules will be available in the mat2, mat3, mat4, vec2, vec3, vec4 namespaces -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gl-matrix/2.8.1/gl-matrix-min.js"></script>

  <script src='webglpp.js'></script>
  <script src='colormap.js'></script>
  <script src='utils.js'></script>

  <style>
    #text {
      background-color: transparent;
      position: absolute;
      left: 0px;
      top: 0px;
      z-index: 10;
    }
    .container {
      position: relative;
    }
  </style>
</head>

<body style='background-color:gray' onload="run();">

  <!-- wrapper -->
  <div class="d-flex" id="wrapper">

    <!-- navigation bar -->
    <nav class="navbar" style="background-color: #000;">
        <a class="navbar-brand" style="color: #fff" href="">webglpp</a>
    </nav> <!-- navigation bar -->

    <!-- page content -->
    <div id="page-content-wrapper">

      <div class="container-fluid" style='position:relative'>
        <button id='button-save-png' onclick='savePNG()'>save PNG</button>
        <button id='reset-view' onclick='resetView()'>reset view</button>
        <input type='checkbox' onchange='visualizer.vertexNumbers = !visualizer.vertexNumbers;visualizer.draw();'>vtx #'s</input>
        <input type='checkbox' onchange='visualizer.triangleNumbers = !visualizer.triangleNumbers;visualizer.draw();'>tri #'s</input>
        <hr>
        <div class='container'>
          <canvas style='background-color:white' width=1000 height=800 id='canvas-visualizer'></canvas>
          <canvas width=1000 height=800 id='text'></canvas>
        </div>
      </div> <!-- container-fluid -->
    </div> <!-- page-content-wrapper -->
  </div> <!-- wrapper -->
</body>

<script>

// use the basic shaders with a uniform in the fragment shader that controls whether the color is black
vertexShaderSource = `#version 300 es
  precision mediump float;
  in vec3 a_Position;
  in vec3 a_Color;
  in vec3 a_Normal;
  in float a_Scalar;

  uniform mat4 u_ModelMatrix;
  uniform mat4 u_ViewMatrix;
  uniform mat4 u_PerspectiveMatrix;
  uniform mat4 u_NormalMatrix;

  uniform vec3  u_color;
  uniform int   u_field;

  out vec3 v_Position;
  out vec3 v_Color;
  out vec3 v_Normal;
  out float v_Scalar;

  void main() {
    gl_Position = u_PerspectiveMatrix * u_ViewMatrix * u_ModelMatrix * vec4(a_Position,1.0);

    if (u_field < 0)
      v_Color = u_color;
    else
      v_Color = a_Color;

    v_Normal = mat3(u_NormalMatrix)*a_Normal;
    v_Position = vec3(u_ViewMatrix * u_ModelMatrix * vec4(a_Position,1.0));
    v_Scalar = a_Scalar;
  }`;
fragmentShaderSource = `#version 300 es
  precision mediump float;
  uniform int   u_edges;
  uniform float u_alpha;

  in vec3 v_Color;
  in vec3 v_Position;
  out vec4 fragColor;
  in float v_Scalar;

  uniform sampler2D u_colormap;

  void
  get_color( in float u , out vec3 color ) {

    // todo make these uniforms that are set by the user
    float umin = 0.0;
    float umax = 1.0;

    float idx = 255.0*(u - umin)/(umax - umin);
    color = texelFetch( u_colormap , ivec2(idx,0) , 0 ).xyz;
  }


  void main() {

    //float x = v_Scalar;
    //vec3 c = texelFetch( u_colormap , ivec2(x,0) , 0 ).xyz;
    vec3 color;
    get_color(v_Scalar,color);

    if (u_edges < 0) {
      //fragColor = vec4(0.8,0.8,0.2,1);
      fragColor = vec4(color,1);
    }
    else {
      fragColor = vec4(0,0,0,1);
    }
  }`;


  let visualizer = undefined;
  function run() {

    let addr = "ws://localhost:7681";
    //addr = "ws://wazowski.middlebury.edu:7682";
    //addr = "ws://140.233.165.163:7682";

    visualizer = new WebGLpp(addr,'canvas-visualizer',vertexShaderSource,fragmentShaderSource);

    let avro = new avroWebGL(visualizer);
    visualizer.connect(addr,avro);
  }

  function savePNG() {
    visualizer.gl.preserveDrawingBuffer = true;
    visualizer.draw();
    visualizer.gl.preserveDrawingBuffer = false;

    let data = visualizer.canvas.toDataURL('image/png');
    let url = data.replace(/^data:image\/png/,'data:application/octet-stream');
    let link = document.createElement('a');
    link.setAttribute('href', url);
    let filename = 'mesh.png';
    link.setAttribute('download',filename);
    link.click();
  }

  function resetView() {
    for (let i = 0; i < visualizer.meshes.length; i++)
      visualizer.meshes[i].modelMatrix = mat4.create();
    visualizer.eye = vec3.fromValues(0,0,-2);
    mat4.lookAt( visualizer.viewMatrix, visualizer.eye, visualizer.center , vec3.fromValues(0,1,0) );
    visualizer.draw();
  }

</script>

</html>
